name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - "charts/**"

jobs:
  release:
    # depending on default permission settings for your org (contents being read-only or read-write for workloads), you will have to add permissions
    # see: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        # TODO: which user should be used here? bot user?
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Run chart-releaser
        id: cr
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          mark_as_latest: false
          skip_existing: true

      # create or update README.md file in gh-pages with list of charts with latest versions

      # checkout gh-pages branch
      - run: |
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages

      - name: Generate chart table with yq
        id: chart_table
        if: steps.cr.outputs.changed_charts != ''
        uses: mikefarah/yq@master
        with:
          cmd: >-
            yq -r '
              "| Chart | Version | Description | Released |\n|------|---------|-------------|----------|",
              (
                .entries
                | to_entries[]
                | .key as $chart
                | .value[0]
                | "| " + $chart
                  + " | [" + .version
                  + "](" + .urls[0]
                  + ") | " + .description
                  + " | " + (.created | split("T")[0])
                  + " |"
              )
            ' index.yaml

      - name: Update gh-pages README
        if: steps.cr.outputs.changed_charts != ''
        shell: bash
        run: |
          CHART_TABLE="${{ steps.chart_table.outputs.result }}"
          echo "Copying README.md from main branch to ensure it is up to date."
          git show origin/main:README.md > README.md
          if grep -q '<!-- start charts -->' README.md; then
            awk -v table="$CHART_TABLE" '
              /<!-- start charts -->/ { print; print table; in_charts=1; next }
              /<!-- end charts -->/ { in_charts=0; print; next }
              !in_charts { print }
            ' README.md > temp_readme.md
            mv temp_readme.md README.md
          else
            echo "No <!-- start charts --> tag found in README.md, skipping chart table update."
          fi

      - name: Commit and push README update
        if: steps.cr.outputs.changed_charts != ''
        run: |
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "docs: update chart list in gh-pages README [skip ci]"
            git push origin gh-pages
          else
            echo "No changes to commit."
          fi
